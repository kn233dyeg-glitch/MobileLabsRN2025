import React, { useState } from 'react';
import { View, Text, StyleSheet, FlatList, SafeAreaView, StatusBar } from 'react-native';
import { NavigationContainer } from '@react-navigation/native';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { GestureHandlerRootView, Gesture, GestureDetector } from 'react-native-gesture-handler';
import Animated, { useSharedValue, useAnimatedStyle, withSpring, runOnJS } from 'react-native-reanimated';
import { Ionicons } from '@expo/vector-icons';

// --- Конфігурація завдань ---
const INITIAL_TASKS = [
  { id: '1', desc: 'Зробити 10 кліків', goal: 10, current: 0, completed: false, type: 'click' },
  { id: '2', desc: 'Подвійний клік 5 разів', goal: 5, current: 0, completed: false, type: 'double' },
  { id: '3', desc: 'Утримувати 3 секунди', goal: 1, current: 0, completed: false, type: 'long' },
  { id: '4', desc: 'Перетягнути об\'єкт', goal: 1, current: 0, completed: false, type: 'pan' },
  { id: '5', desc: 'Змінити розмір (Pinch)', goal: 1, current: 0, completed: false, type: 'pinch' },
  { id: '6', desc: 'Набрати 100 очок', goal: 100, current: 0, completed: false, type: 'total' },
];

// --- Екран Гри ---
const ClickerScreen = ({ route }) => {
  const { score, setScore, tasks, setTasks } = route.params;

  // Анімаційні значення
  const offset = useSharedValue({ x: 0, y: 0 });
  const scale = useSharedValue(1);
  const savedScale = useSharedValue(1);

  // Функція оновлення прогресу (має викликатися через runOnJS)
  const handleAction = (type, points) => {
    setScore(prev => {
      const newScore = prev + points;
      setTasks(currentTasks => currentTasks.map(task => {
        if (task.type === type && !task.completed) {
          const nextVal = task.current + 1;
          return { ...task, current: nextVal, completed: nextVal >= task.goal };
        }
        if (task.type === 'total' && !task.completed) {
          return { ...task, current: newScore, completed: newScore >= task.goal };
        }
        return task;
      }));
      return newScore;
    });
  };

  // Визначення жестів через новий API
  const tap = Gesture.Tap()
    .onStart(() => { runOnJS(handleAction)('click', 1); });

  const doubleTap = Gesture.Tap()
    .numberOfTaps(2)
    .onStart(() => { runOnJS(handleAction)('double', 2); });

  const longPress = Gesture.LongPress()
    .minDuration(3000)
    .onStart(() => { runOnJS(handleAction)('long', 10); });

  const pan = Gesture.Pan()
    .onUpdate((e) => {
      offset.value = { x: e.translationX, y: e.translationY };
    })
    .onEnd(() => {
      offset.value = withSpring({ x: 0, y: 0 });
      runOnJS(handleAction)('pan', 1);
    });

  const pinch = Gesture.Pinch()
    .onUpdate((e) => {
      scale.value = savedScale.value * e.scale;
    })
    .onEnd(() => {
      savedScale.value = scale.value;
      runOnJS(handleAction)('pinch', 5);
    });

  // Комбінуємо жести: doubleTap має пріоритет над tap
  const composed = Gesture.Race(
    doubleTap,
    Gesture.Exclusive(pan, pinch, longPress, tap)
  );

  const animatedStyle = useAnimatedStyle(() => ({
    transform: [
      { translateX: offset.value.x },
      { translateY: offset.value.y },
      { scale: scale.value }
    ]
  }));

  return (
    <View style={styles.center}>
      <Text style={styles.scoreText}>Рахунок: {score}</Text>
      <GestureDetector gesture={composed}>
        <Animated.View style={[styles.circle, animatedStyle]}>
          <Ionicons name="finger-print" size={50} color="white" />
        </Animated.View>
      </GestureDetector>
      <Text style={styles.hint}>Клікай, тримай 3с, тягни або стискай!</Text>
    </View>
  );
};

// --- Екран Завдань ---
const TasksScreen = ({ route }) => {
  const { tasks } = route.params;
  return (
    <SafeAreaView style={styles.container}>
      <Text style={styles.header}>Список завдань</Text>
      <FlatList
        data={tasks}
        keyExtractor={item => item.id}
        renderItem={({ item }) => (
          <View style={[styles.taskCard, item.completed && styles.taskDone]}>
            <View style={{ flex: 1 }}>
              <Text style={styles.taskDesc}>{item.desc}</Text>
              <Text style={styles.taskProgress}>
                Прогрес: {item.type === 'total' ? item.current : `${item.current} / ${item.goal}`}
              </Text>
            </View>
            {item.completed && <Ionicons name="checkmark-circle" size={24} color="green" />}
          </View>
        )}
      />
    </SafeAreaView>
  );
};

// --- Навігація ---
const Tab = createBottomTabNavigator();

export default function App() {
  const [score, setScore] = useState(0);
  const [tasks, setTasks] = useState(INITIAL_TASKS);

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <NavigationContainer>
        <StatusBar barStyle="dark-content" />
        <Tab.Navigator screenOptions={{ tabBarActiveTintColor: '#007AFF' }}>
          <Tab.Screen 
            name="Клікер" 
            children={() => <ClickerScreen route={{ params: { score, setScore, tasks, setTasks } }} />}
            options={{ tabBarIcon: ({color}) => <Ionicons name="game-controller" size={24} color={color}/> }}
          />
          <Tab.Screen 
            name="Завдання" 
            children={() => <TasksScreen route={{ params: { tasks } }} />}
            options={{ tabBarIcon: ({color}) => <Ionicons name="list" size={24} color={color}/> }}
          />
        </Tab.Navigator>
      </NavigationContainer>
    </GestureHandlerRootView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#f8f9fa' },
  center: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#fff' },
  scoreText: { fontSize: 48, fontWeight: '900', color: '#007AFF', marginBottom: 30 },
  circle: { width: 120, height: 120, backgroundColor: '#007AFF', borderRadius: 60, justifyContent: 'center', alignItems: 'center', elevation: 10, shadowColor: '#000', shadowOpacity: 0.2, shadowRadius: 10 },
  hint: { marginTop: 40, color: '#888', fontSize: 12 },
  header: { fontSize: 24, fontWeight: 'bold', padding: 20, textAlign: 'center' },
  taskCard: { flexDirection: 'row', backgroundColor: 'white', padding: 15, marginHorizontal: 20, marginBottom: 10, borderRadius: 12, alignItems: 'center', elevation: 2 },
  taskDone: { backgroundColor: '#e8f5e9' },
  taskDesc: { fontSize: 16, fontWeight: '600' },
  taskProgress: { fontSize: 13, color: '#666', marginTop: 4 }
});
